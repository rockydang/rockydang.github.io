---
layout:     post
title:      分库分表
subtitle:    "\"技术博客列表\""
date:       2017-02-15
author:     rockybobo
header-img: img/myname/post_20170212_01.jpg
catalog: true
tags:
    - 技术
---

## 分库分表

 #### 垂直分表

> 大表拆小表

#### 垂直分库

> 垂直分库在“微服务”盛行的今天已经非常普及了。基本的思路就是按照业务模块来划分出不同的数据库，
>  而不是像早期一样将所有的数据表都放到同一个数据库中
>
> 众所周知，数据库往往最容易成为应用系统的瓶颈，而数据库本身属于“有状态”的，相对于Web和应用服务器来讲，是比较难实现“横向扩展”的。数据库的连接资源比较宝贵且单机处理能力也有限，在高并发场景下，垂直分库一定程度上能够突破IO、连接数及单机硬件资源的瓶颈，是大型分布式系统中优化数据库架构的重要手段。

#### 水平分表

> 水平分表也称为横向分表，比较容易理解，就是将表中不同的数据行按照一定规律分布到不同的数据库表中（这些表保存在同一个数据库中），
>   这样来降低单表数据量，优化查询性能。最常见的方式就是通过主键或者时间等字段进行Hash和取模后拆分
> 小结：
>   水平分表，能够降低单表的数据量，一定程度上可以缓解查询性能瓶颈。但本质上这些表还保存在同一个库中，所以库级别还是会有IO瓶颈。所以，一般不建议采用这种做法。

#### 水平分库分表

> 水平分库分表与上面讲到的水平分表的思想相同，唯一不同的就是将这些拆分出来的表保存在不同的数据中。这也是很多大型互联网公司所选择的做法。 
>
> 
>
> 某种意义上来讲，有些系统中使用的“冷热数据分离”（将一些使用较少的历史数据迁移到其他的数据库中。而在业务功能上，通常默认只提供热点数据的查询），也是类似的实践。在高并发和海量数据的场景下，分库分表能够有效缓解单机和单库的性能瓶颈和压力，突破IO、连接数、硬件资源的瓶颈。

  

分库分表的难点
   跨库join的问题
   1.跨库Join的几种解决思路

> a.全局表
>    所谓全局表，就是有可能系统中所有模块都可能会依赖到的一些表。比较类似我们理解的“数据字典”。为了避免跨库join查询，我们可以将这类表在其他每个数据库中均保存一份。
>    同时，这类数据通常也很少发生修改（甚至几乎不会），所以也不用太担心“一致性”问题。
>  b.字段冗余
>    这是一种典型的反范式设计，在互联网行业中比较常见，通常是为了性能来避免join查询。
>    字段冗余能带来便利，是一种“空间换时间”的体现。但其适用场景也比较有限，比较适合依赖字段较少的情况。
>  c.数据同步
>    定时A库中的tab_a表和B库中tbl_b有关联，可以定时将指定的表做同步。当然，同步本来会对数据库带来一定的影响，需要性能影响和数据时效性中取得一个平衡。
>    这样来避免复杂的跨库查询。笔者曾经在项目中是通过ETL工具来实施的。
>  d.系统层组装
>    在系统层面，通过调用不同模块的组件或者服务，获取到数据并进行字段拼装。说起来很容易，但实践起来可真没有这么简单，
>    尤其是数据库设计上存在问题但又无法轻易调整的时候。



总结：

```
简单字段组装的情况下，我们只需要先获取“主表”数据，然后再根据关联关系，调用其他模块的组件或服务来获取依赖的
其他字段（如例中依赖的用户信息），最后将数据进行组装。
```

  跨库事务（分布式事务）的问题
   按业务拆分数据库之后，不可避免的就是“分布式事务”的问题。以往在代码中通过spring注解简单配置就能实现事务的，
   现在则需要花很大的成本去保证一致性。这里不展开介绍， 感兴趣的读者可以自行参考《分布式事务一致性解决方案》，链接地址： 
   http://www.infoq.com/cn/articles/solution-of-distributed-system-transaction-consistency

----分布式系统----
分布式系统中，同时满足“CAP定律”中的“一致性”、“可用性”和“分区容错性”三者是不可能
都需要牺牲强一致性来换取系统的高可用性，系统往往只需要保证“最终一致性”，只要这个最终时间是在用户可以接受的范围内即可。

